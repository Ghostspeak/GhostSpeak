name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  lint:
    name: Lint & Format
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            ~/.cargo/registry
            ~/.cargo/git
            target
            node_modules
          key: ${{ runner.os }}-lint-${{ hashFiles('**/bun.lock', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-lint-
      
      - name: Install dependencies
        run: bun install
      
      - name: Lint TypeScript
        run: bun run lint:ts
      
      - name: Check Rust formatting
        run: cd programs && cargo fmt -- --check
      
      - name: Lint Rust
        run: cd programs && cargo clippy -- -D warnings

  build:
    name: Build
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential libudev-dev
      
      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install 0.32.1
          avm use 0.32.1
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            ~/.cargo/registry
            ~/.cargo/git
            target
            node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('**/bun.lock', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-
      
      - name: Install dependencies
        run: bun install
      
      - name: Build Anchor programs
        run: anchor build
      
      - name: Build SDK
        run: cd packages/sdk-typescript && bun run build
      
      - name: Build CLI
        run: cd packages/cli && bun run build
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target/deploy/
            target/idl/
            packages/sdk-typescript/dist/
            packages/cli/dist/

  test:
    name: Test
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: build
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-test-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-test-
      
      - name: Install dependencies
        run: bun install
      
      - name: Run SDK unit tests
        run: cd packages/sdk-typescript && bun run test:unit
        timeout-minutes: 5
      
      - name: Run CLI tests
        run: cd packages/cli && bun run test:unit
        timeout-minutes: 5

  security:
    name: Security Audit
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Audit Rust dependencies
        run: cd programs && cargo audit
      
      - name: Audit Node dependencies
        run: bun audit --audit-level=high || true  # Don't fail on npm audit issues
